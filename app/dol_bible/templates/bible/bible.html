<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Word - Dialogues of Light</title>
    <link rel="stylesheet" href="{{ url_for('bible.static', filename='bible.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

    <div class="bible-reader-container">
        
        <header class="bible-header">
            <div class="header-accent-dots">
                <a href="{{ url_for('main.splash') }}" class="home-link" title="Back to Welcome Page"></a>
            </div>
            <div class="search-controls">
                <form id="bible-search-form">
                    <div class="search-input-wrapper with-suggestions">
                        <i class="fas fa-book-bible"></i>
                        <input type="text" id="passage-input" placeholder="e.g., John 3:16 or Genesis" required autocomplete="off">
                        <div id="suggestions-container" class="suggestions-container"></div>
                    </div>
                    <select id="translation-select" title="Select Bible Version"></select>
                    <button type="submit" title="Search"><i class="fas fa-search"></i></button>
                </form>
                <button id="theme-toggle" title="Toggle Day/Night Mode">
                    <i class="fas fa-sun"></i>
                </button>
            </div>
        </header>

        <main class="results-panel" id="results-panel">
            <div id="status-container" class="status-container"></div>
            <div id="scripture-content-wrapper">
                <div class="welcome-message">
                    <h2>The Word of God</h2>
                    <p><small> Study the Bible before Bible Study</small></p>
                    <p>Enter a scripture reference (e.g., <strong>Psalm 23</strong>) or a book name (e.g., <strong>Jude</strong>) to begin reading.</p>
                </div>
            </div>
            <div id="navigation-controls" class="navigation-controls hidden">
                <button id="prev-chapter-btn" class="nav-btn">
                    <i class="fas fa-arrow-left"></i> Previous Chapter
                </button>
                <button id="next-chapter-btn" class="nav-btn">
                    Next Chapter <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </main>

        <footer class="site-footer">
            <div class="footer-bottom">
                <!-- Updated footer text to remove external API credit -->
                <p>Â© {{ now().year }} - Dialogues of Light. Scripture passages are from public domain sources.</p>
            </div>
        </footer>

    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // =========================================================================
    // 1. STATE MANAGEMENT & DYNAMIC METADATA
    // =========================================================================
    let BIBLE_METADATA = {};
    let BIBLE_BOOK_ORDER = [];
    let currentChapterState = { version: null, book: null, chapter: null };
    let debounceTimer;

    // =========================================================================
    // 2. DOM ELEMENT REFERENCES
    // =========================================================================
    const searchForm = document.getElementById('bible-search-form');
    const passageInput = document.getElementById('passage-input');
    const translationSelect = document.getElementById('translation-select');
    const statusContainer = document.getElementById('status-container');
    const scriptureWrapper = document.getElementById('scripture-content-wrapper');
    const navControls = document.getElementById('navigation-controls');
    const prevChapterBtn = document.getElementById('prev-chapter-btn');
    const nextChapterBtn = document.getElementById('next-chapter-btn');
    const themeToggle = document.getElementById('theme-toggle');
    const body = document.body;
    const suggestionsContainer = document.getElementById('suggestions-container');
    
    // =========================================================================
    // 3. INITIALIZATION
    // =========================================================================
    
    async function initializeReader() {
        setupTheme();
        await populateTranslations();
        const defaultVersion = translationSelect.value;
        if (defaultVersion) {
            await loadBibleMetadata(defaultVersion);
        }
        searchForm.addEventListener('submit', handleSearch);
        passageInput.addEventListener('input', handleLiveSearch);
        // Hide suggestions when clicking away
        document.addEventListener('click', (e) => {
            if (!passageInput.contains(e.target)) {
                suggestionsContainer.style.display = 'none';
            }
        });
        prevChapterBtn.addEventListener('click', () => navigateChapter('prev'));
        nextChapterBtn.addEventListener('click', () => navigateChapter('next'));
        translationSelect.addEventListener('change', handleTranslationChange);
        checkForUrlQuery();
    }

    // --- NEW: Function to display suggestions ---
    function showSuggestions(query) {
        if (!query || BIBLE_BOOK_ORDER.length === 0) {
            suggestionsContainer.innerHTML = '';
            suggestionsContainer.style.display = 'none';
            return;
        }

        const lowerQuery = query.toLowerCase();
        // Filter the book list to find matches
        const matches = BIBLE_BOOK_ORDER.filter(book => book.toLowerCase().startsWith(lowerQuery)).slice(0, 7); // Show max 7 suggestions

        if (matches.length === 0) {
            suggestionsContainer.style.display = 'none';
            return;
        }

        suggestionsContainer.innerHTML = matches.map(book => `<div class="suggestion-item" data-book="${book}">${book}</div>`).join('');
        suggestionsContainer.style.display = 'block';

        // Add click listeners to the new suggestion items
        document.querySelectorAll('.suggestion-item').forEach(item => {
            item.addEventListener('click', () => {
                passageInput.value = item.dataset.book + ' '; // Add space for chapter number
                suggestionsContainer.style.display = 'none';
                passageInput.focus();
                // Optional: Automatically search for the first chapter
                // handleSearch();
            });
        });
    }

    async function populateTranslations() {
        try {
            const response = await fetch("{{ url_for('bible.get_translations') }}");
            const translations = await response.json();
            
            translationSelect.innerHTML = ''; // Clear existing options
            translations.forEach(t => {
                const option = document.createElement('option');
                option.value = t.abbreviation;
                option.textContent = t.abbreviation;
                translationSelect.appendChild(option);
            });
        } catch (error) {
            setStatus('error', 'Could not load Bible versions. Please check server connection.');
            console.error('Failed to populate translations:', error);
        }
    }

    async function loadBibleMetadata(version) {
        try {
            const response = await fetch(`{{ url_for('bible.get_metadata', version='__VERSION__') }}`.replace('__VERSION__', version));
            const data = await response.json();
            BIBLE_METADATA = data.books;
            BIBLE_BOOK_ORDER = data.bookOrder;
        } catch (error) {
            setStatus('error', 'Could not load Bible metadata.');
            console.error(`Failed to load metadata for ${version}:`, error);
        }
    }

    // =========================================================================
    // 4. PARSER & API LOGIC
    // =========================================================================

    async function handleSearch(event) {
        if (event) event.preventDefault();
        const query = passageInput.value.trim();
        const version = translationSelect.value;
        if (!query) return;

        setStatus('loading', 'Loading scripture...');

        try {
            const response = await fetch(`{{ url_for('bible.intelligent_search') }}?q=${encodeURIComponent(query)}&t=${version}`);
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'Passage not found.');
            }
            displayResults(data);
        } catch (error) {
            console.error('API Fetch Error:', error);
            setStatus('error', `Error: ${error.message}`);
        }
    }

    function handleLiveSearch() {
        clearTimeout(debounceTimer);
        const query = passageInput.value.trim();
        showSuggestions(query);
        debounceTimer = setTimeout(() => {
            // This could be enhanced to show suggestions, but for now we'll just search on Enter
            // performFullTextSuggestion(query);
        }, 300);
    }
    
    async function handleTranslationChange() {
        await loadBibleMetadata(translationSelect.value);
        if (currentChapterState.book) {
            const query = `${currentChapterState.book} ${currentChapterState.chapter}`;
            passageInput.value = query;
            handleSearch();
        }
    }
    
    function navigateChapter(direction) {
        const { version, book, chapter } = currentChapterState;
        if (!book || !BIBLE_BOOK_ORDER.length) return;

        const currentIndex = BIBLE_BOOK_ORDER.indexOf(book);
        const totalChapters = BIBLE_METADATA[book];
        let newBook = book;
        let newChapter = chapter;

        if (direction === 'next') {
            if (chapter < totalChapters) {
                newChapter++;
            } else if (currentIndex < BIBLE_BOOK_ORDER.length - 1) {
                newBook = BIBLE_BOOK_ORDER[currentIndex + 1];
                newChapter = 1;
            }
        } else { // 'prev'
            if (chapter > 1) {
                newChapter--;
            } else if (currentIndex > 0) {
                newBook = BIBLE_BOOK_ORDER[currentIndex - 1];
                newChapter = BIBLE_METADATA[newBook];
            }
        }
        passageInput.value = `${newBook} ${newChapter}`;
        handleSearch();
    }

    function displayResults(data) {
        setStatus('clear');
        scriptureWrapper.innerHTML = '';
        
        if (!data.verses || data.verses.length === 0) {
            setStatus('error', 'No results found.');
            return;
        }

        const firstVerse = data.verses[0];
        currentChapterState = {
            version: data.translation_abbreviation,
            book: firstVerse.name,
            chapter: firstVerse.chapter
        };

        const referenceHeader = document.createElement('h2');
        referenceHeader.className = 'scripture-reference';
        referenceHeader.textContent = data.reference;

        const translationName = document.createElement('span');
        translationName.className = 'translation-name';
        translationName.textContent = data.translation_name;

        const scriptureText = document.createElement('div');
        scriptureText.className = 'scripture-text';
        
        const paragraph = document.createElement('p');
        data.verses.forEach(verse => {
            const verseContainer = document.createElement('span');
            const verseNumber = document.createElement('sup');
            verseNumber.textContent = verse.verse;
            const verseText = document.createTextNode(` ${verse.text.trim()} `);
            verseContainer.appendChild(verseNumber);
            verseContainer.appendChild(verseText);
            paragraph.appendChild(verseContainer);
        });
        
        scriptureText.appendChild(paragraph);
        scriptureWrapper.appendChild(referenceHeader);
        scriptureWrapper.appendChild(translationName);
        scriptureWrapper.appendChild(scriptureText);

        updateNavigationControls();
    }
    
    function updateNavigationControls() {
        const { book, chapter } = currentChapterState;
        if (!book || !chapter || !BIBLE_METADATA[book]) {
            navControls.classList.add('hidden');
            return;
        }
        const totalChapters = BIBLE_METADATA[book];
        const currentIndex = BIBLE_BOOK_ORDER.indexOf(book);
        const prevBook = BIBLE_BOOK_ORDER[(currentIndex - 1 + BIBLE_BOOK_ORDER.length) % BIBLE_BOOK_ORDER.length];
        prevChapterBtn.innerHTML = (chapter > 1) ? `<i class="fas fa-arrow-left"></i> Previous Chapter` : `<i class="fas fa-arrow-left"></i> Previous Book (${prevBook})`;
        const nextBook = BIBLE_BOOK_ORDER[(currentIndex + 1) % BIBLE_BOOK_ORDER.length];
        nextChapterBtn.innerHTML = (chapter < totalChapters) ? `Next Chapter <i class="fas fa-arrow-right"></i>` : `Next Book (${nextBook}) <i class="fas fa-arrow-right"></i>`;
        navControls.classList.remove('hidden');
    }

    function setStatus(type, message = '') {
        scriptureWrapper.classList.remove('is-loading');
        statusContainer.style.display = 'none';
        statusContainer.className = 'status-container';
        if (type === 'loading') {
            statusContainer.className = 'status-container loading';
            statusContainer.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${message}`;
            statusContainer.style.display = 'block';
            scriptureWrapper.classList.add('is-loading');
            navControls.classList.add('hidden');
        } else if (type === 'error') {
            statusContainer.className = 'status-container error';
            statusContainer.innerHTML = message;
            statusContainer.style.display = 'block';
            scriptureWrapper.innerHTML = '';
            navControls.classList.add('hidden');
        }
    }

    function setupTheme() {
        themeToggle.addEventListener('click', () => {
            const isDayMode = body.classList.contains('day-mode');
            setTheme(isDayMode ? 'night' : 'day');
        });
        const savedTheme = localStorage.getItem('bible-theme') || 'night';
        setTheme(savedTheme);
    }
    
    function setTheme(theme) {
        if (theme === 'day') {
            body.classList.add('day-mode');
            themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
        } else {
            body.classList.remove('day-mode');
            themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
        }
        localStorage.setItem('bible-theme', theme);
    }

    function checkForUrlQuery() {
        const urlParams = new URLSearchParams(window.location.search);
        const passageQuery = urlParams.get('passage');
        if (passageQuery) {
            passageInput.value = decodeURIComponent(passageQuery);
            setTimeout(() => handleSearch(), 100); 
        }
    }

    // Start the application
    initializeReader();
});
</script>

</body>
</html>