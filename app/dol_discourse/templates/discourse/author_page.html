{% extends "layout.html" %}

{% block title %}{{ author.name }} {{ author.other_names }} - Dialogues of Light{% endblock %}

{% block head_extensions %}
    <!-- Re-using dialogues.css as it has the core theme styles -->
    <link rel="stylesheet" href="{{ url_for('discourse.static', filename='dialogues.css') }}">
{% endblock %}

{% block content %}
<!-- ================================================================ -->
<!-- NEW: STICKY HEADER FOR AUTHOR ACTIONS                            -->
<!-- ================================================================ -->
<header class="sticky-main-header author-actions-header">
    <nav class="action-nav">
        <button class="action-btn" data-bs-toggle="modal" data-bs-target="#mentorshipModal">
            <i class="fas fa-user-graduate"></i> Mentorship Request
        </button>
        <button class="action-btn" data-bs-toggle="modal" data-bs-target="#reviewModal">
            <i class="fas fa-pen-nib"></i> Peer Review Request
        </button>
        <button class="action-btn" data-bs-toggle="modal" data-bs-target="#lecturesModal">
            <i class="fas fa-chalkboard-teacher"></i> Lectures
        </button>
        <button class="action-btn" data-bs-toggle="modal" data-bs-target="#consultationModal">
            <i class="far fa-calendar-check"></i> Consultation Diary
        </button>
    </nav>
</header>

<div class="author-page-grid">

    <!-- ================================================================ -->
    <!-- LEFT COLUMN: AUTHOR PROFILE & STATS (Sticky)                     -->
    <!-- ================================================================ -->
    <aside class="author-profile-panel">
        <div class="author-card mb-3">
            <div class="author-photo">
                <img src="{{ url_for('static', filename='images/profile_pics/' + author.profile_picture) }}" alt="Photo of {{ author.name }}">
            </div>
            <h2 class="author-name">{{ author.name }} {{ author.other_names }}</h2>
            <p class="author-organization">{{ author.organization_name or 'Independent Scholar' }}</p>

            <div class="author-contact-info">
                {% if author.website %}<a href="{{ author.website }}" target="_blank" rel="noopener noreferrer"><i class="fas fa-globe"></i> Website</a>{% endif %}
                {% if author.email %}<a href="mailto:{{ author.email }}"><i class="fas fa-envelope"></i> Email</a>{% endif %}
            </div>

            <div class="author-details">
                <div class="detail-item">
                    <h4>Education</h4>
                    <p>{{ author.education or 'Not provided' }}</p>
                </div>
                <div class="detail-item">
                    <h4>Career & Vocation</h4>
                    <p>{{ author.career or 'Not provided' }}</p>
                </div>
            </div>
        </div>
        <!-- "At a Glance" card is now here -->
        <div class="stats-card">
            <h4>At a Glance</h4>
            <div class="stat-item">
                <span class="stat-value">{{ discourses | length }}</span>
                <span class="stat-label">Total Contributions</span>
            </div>
            <div class="stat-item">
                <span class="stat-value">{{ total_comments }}</span>
                <span class="stat-label">Comments on Works</span>
            </div>
        </div>
    </aside>

    <!-- ================================================================ -->
    <!-- RIGHT COLUMN (Previously Center): PUBLICATIONS LIST              -->
    <!-- ================================================================ -->
    <main class="author-publications-panel">
        <!-- The form now handles the search -->
        <form method="GET" action="{{ url_for('discourse.dialogues_by_author', user_id=author.id) }}">
            <div class="publications-header">
                <h3>Published Works</h3>
                <div class="search-wrapper">
                    <input type="text" name="search" id="publication-search" placeholder="Search publications..." value="{{ search_query or '' }}">
                    <!-- The icon is now inside a button to submit the form -->
                    <button type="submit" class="search-icon-btn"><i class="fas fa-search"></i></button>
                </div>
            </div>
        </form>

        <div class="publications-list">
            {% for discourse in discourses %}
            <a href="{{ url_for('discourse.dialogues', discourse_id=discourse.id) }}" class="publication-item">
                <div class="item-content">
                    <h4 class="publication-title">{{ discourse.title }}</h4>
                    <p class="publication-category">
                        {{ discourse.subcategory.category.name }} / {{ discourse.subcategory.name }}
                    </p>
                </div>
                <div class="item-meta">
                    <span class="publication-date">{{ discourse.date_posted.strftime('%b %d, %Y') }}</span>
                    <i class="fas fa-chevron-right"></i>
                </div>
            </a>
            {% else %}
            <p class="no-publications">
                {% if search_query %}
                    No publications found matching "<strong>{{ search_query }}</strong>".
                {% else %}
                    This author has no published works yet.
                {% endif %}
            </p>
            {% endfor %}
        </div>
        
        <!-- NEW: Render pagination controls at the bottom of the panel -->
        <div class="publication-pagination">
            {{ pagination.links }}
        </div>
    </main>
</div>

<!-- ================================================================ -->
<!-- MODAL INCLUDES                                                   -->
<!-- ================================================================ -->
{% include 'forms/_mentorship_modal.html' %}
{% include 'forms/_review_modal.html' %}
{% include 'forms/_lectures_modal.html' %}
{% include 'forms/_consultation_modal.html' %}


<!-- Add Bootstrap JS for modal functionality -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Search logic is unchanged
    const searchInput = document.getElementById('publication-search');
    const publicationItems = document.querySelectorAll('.publication-item');

    searchInput.addEventListener('input', () => {
        const query = searchInput.value.toLowerCase().trim();
        publicationItems.forEach(item => {
            const title = item.dataset.title;
            if (title.includes(query)) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    });
});
</script>
{% endblock %}