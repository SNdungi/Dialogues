

{% extends "layout.html" %}

{% block content %}
    <!-- Sticky Header within Main Content -->
    <div class="sticky-main-header d-flex justify-content-between align-items-center g-5">
        <h3 class="me-5 mb-0">Daily Discourse</h3>

        <!-- ================================================================ -->
        <!-- FIX 1: Buttons moved to the header for better usability.         -->
        <!-- They are disabled via Jinja if there's no initial content.     -->
        <!-- ================================================================ -->
        <div class="discourse-navigation-controls">
            <button id="prev-discourse-btn" class="btn btn-outline-secondary btn-sm" title="Previous Discourse" {% if not initial_content %}disabled{% endif %}>
                <i class="fa fa-chevron-left"></i>
            </button>
            <button id="next-discourse-btn" class="btn btn-outline-secondary btn-sm" title="Next Discourse" {% if not initial_content %}disabled{% endif %}>
                <i class="fa fa-chevron-right"></i>
            </button>
        </div>
        
        <!-- Search Bar -->
        <div>
            <input type="text" class="search-input" placeholder="Search Topics, Titles..." id="searchInput">
            <button class="search-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"/></svg>
            </button>
        </div>
        
        <!-- Action Buttons -->
        <div class="d-flex align-items-center ms-3">
            {% if initial_content and current_user.is_authenticated and (current_user.id == initial_content.author.id or current_user.has_role('Admin') or current_user.has_role('Editor')) %}
                <a href="{{ url_for('discourse.edit_discourse', discourse_id=initial_content.id) }}" class="btn btn-secondary btn-sm me-2">
                    <i class="fa fa-pencil-alt"></i>
                </a>
            {% endif %}
            <a href="{{ url_for('discourse.new_discourse_editor') }}" class="btn btn-warning btn-sm">
                <i class="fa fa-plus"></i>
            </a>
        </div>
    </div>

    <!-- Main content container -->
    <div class="discourse-container" id="discourse-content-wrapper" data-initial-discourse-id="{{ initial_content.id if initial_content else '' }}">
        
        {% if initial_content %}
            <section id="discourse-section">
                <div class="discourse-meta">
                    <span id="discourse-date">{{ initial_content.date_posted.strftime('%B %d, %Y') }}</span>
                    <div id="discourse-category-container">
                        {% if initial_content.subcategory and initial_content.subcategory.category %}
                            <span class="discourse-category">
                                {{ initial_content.subcategory.category.name }} > {{ initial_content.subcategory.name }}
                            </span>
                        {% endif %}
                    </div>
                    <span id="discourse-ref">Reference: {{ initial_content.reference }}</span>
                </div>
                
                <h4 id="discourse-title">{{ initial_content.title }}</h4>
                
                <div id="featured-image-container">
                    {% if initial_content.featured_image %}
                    <img src="{{ url_for('static', filename='uploads/discourse_images/' + initial_content.featured_image) }}" alt="{{ initial_content.title }}" class="featured-image">
                    {% endif %}
                </div>
                
                <div id="discourse-body">
                    {{ initial_content.body | safe }}
                </div>
                <div class="discourse-meta-footer">
                    <!-- CHANGE 1: Add ID to the author name span for JS targeting -->
                    <span id="discourse-author-name"> 
                        <strong>Author: </strong> {{ initial_content.author.name }} {{ initial_content.author.other_names }}
                    </span>

                    <!-- CHANGE 2: Add data attributes to the button to trigger the modal -->
                    <button id="about-author-btn" class="btn btn-sm btn-warning" type="button" data-bs-toggle="modal" data-bs-target="#authorDetailModal">
                         About Author
                    </button>
                </div>
            </section>

            <section id="resources-section">
                <h4>Resources & References</h4>
                <ul id="resource-list">
                    {% for resource in initial_content.resources %}
                    <li>
                        {% set resource_slug = resource.type.name | lower | replace('_', '-') %}
                        <span class="resource-type" style="--resource-bg-color: var(--color-resource-{{ resource_slug }});">
                            {{ resource.type.value[0] }}
                        </span>
                        <strong>{{ resource.name }}:</strong> 
                        {% if resource.link %}
                            <a href="{{ resource.link }}" target="_blank" rel="noopener noreferrer">                                
                                {% if resource.type.name == 'SCRIPTURE' %}
                                    <i class="fas fa-book-bible" aria-hidden="true" title="Read Scripture"></i>
                                {% else %}
                                    <i class="fas fa-link" aria-hidden="true" title="External Link"></i>
                                {% endif %}
                            </a>
                        {% endif %}
                    </li>
                    {% else %}
                    <li>No resources are listed for this discourse.</li>
                    {% endfor %}
                </ul>
            </section>

            <section id="contribute-section">
                <h4>Join this Discourse</h4>
                <p id="contribute-prompt">Share your thoughts on '{{ initial_content.title }}'.</p>
                <textarea id="comment-textarea" placeholder="Contribute your perspective..." maxlength="1000"></textarea>
                <small id="char-counter" class="text-muted mb-2">0 / 1000</small>
                <div class="d-flex justify-content-between align-items-center mt-2">
                    <button id="submit-comment-btn" class="btn btn-sm btn-primary">Submit Contribution</button>
                    <small id="comment-status-msg" class="text-muted"></small>
                </div>
            </section>

            <section id="comments-section" class="mt-4">
                <div class="d-flex justify-content-center">
                <button class="btn btn-secondary btn-sm rounded-pill px-3" 
                        type="button" 
                        data-bs-toggle="collapse" 
                        data-bs-target="#comments-collapse-wrapper" 
                        aria-expanded="false" 
                        aria-controls="comments-collapse-wrapper" 
                        id="view-comments-btn">
                    View Contributions ({{ initial_content.comments|length }})
                </button>
                </div>

                <div class="collapse" id="comments-collapse-wrapper">
                    <div class="card card-body mt-2" id="comment-list-container">
                        {% for comment in initial_content.comments | sort(attribute='date_commented') %}
                            <div class="comment-item">
                                <p class="comment-body mb-1">{{ comment.body }}</p>
                                <small class="comment-meta text-muted">
                                    &mdash; {{ comment.commenter.name }} {{ comment.commenter.other_names }} on {{ comment.date_commented.strftime('%b %d, %Y') }}
                                </small>
                            </div>
                        {% else %}
                            <p class="text-center text-muted m-2">Be the first to contribute!</p>
                        {% endfor %}
                    </div>
                </div>
            </section>

        {% else %}
            <!-- B. Display a welcoming "empty state" -->
            <section id="discourse-section" class="empty-state">
                <div class="discourse-meta">
                    <span id="discourse-date">Today</span>
                    <span id="discourse-ref">Reference: N/A</span>
                </div>
                <h4 id="discourse-title">Welcome to the Dialogues</h4>
                <div id="discourse-body">
                    <p>There are no approved articles to display at the moment.</p>
                </div>
            </section>

            <section id="resources-section" class="empty-state">
                <h4>Resources & References</h4>
                <ul id="resource-list"><li>No resources to display.</li></ul>
            </section>

            <section id="contribute-section" class="empty-state">
                <h4>Join this Discourse</h4>
                <p id="contribute-prompt">Share your thoughts once a topic is available.</p>
                <textarea id="comment-textarea" placeholder="Contribute your perspective..." disabled></textarea>
                 <div class="d-flex justify-content-between">
                    <button id="submit-comment-btn" class="btn btn-sm btn-primary" disabled>Submit Contribution</button>
                </div>
            </section>
        {% endif %}
    </div>
        {% if initial_content %}
        {% with author=initial_content.author %}
            {% include '_author.html' %}
        {% endwith %}
    {% endif %}

    <script>
        const textarea = document.getElementById("comment-textarea");
        const counter = document.getElementById("char-counter");

        textarea.addEventListener("input", () => {
            counter.textContent = `${textarea.value.length} / 1000`;
        });
    </script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const container = document.getElementById('discourse-content-wrapper');
        if (!container) return;

        // --- 1. ELEMENT CACHING & STATE ---
        const prevBtn = document.getElementById('prev-discourse-btn');
        const nextBtn = document.getElementById('next-discourse-btn');
        // MODIFIED: Added caching for all comment-related elements
        const commentTextarea = document.getElementById('comment-textarea');
        const submitCommentBtn = document.getElementById('submit-comment-btn');
        const commentStatusMsg = document.getElementById('comment-status-msg');
        const viewCommentsBtn = document.getElementById('view-comments-btn');
        const commentListContainer = document.getElementById('comment-list-container');
        
        const navigationState = { currentId: null, prevId: null, nextId: null };
        

        // --- 2. CORE FUNCTIONS ---

        /**
         * MODIFIED: This function now also updates the collapsible comments section.
         */
        function updateDiscourseContent(discourse) {
            // (Concise Old Content: This part updated title, body, resources, etc.)
            const titleEl = document.getElementById('discourse-title');
            const bodyEl = document.getElementById('discourse-body');
            const dateEl = document.getElementById('discourse-date');
            const refEl = document.getElementById('discourse-ref');
            const promptEl = document.getElementById('contribute-prompt');
            const imageContainer = document.getElementById('featured-image-container');
            const resourceList = document.getElementById('resource-list');
            const categoryContainer = document.getElementById('discourse-category-container');

            if (titleEl) titleEl.textContent = discourse.title || 'N/A';
            if (dateEl) dateEl.textContent = discourse.date_posted || '';
            if (refEl) refEl.textContent = discourse.reference ? `Reference: ${discourse.reference}` : '';
            if (promptEl) promptEl.textContent = `Share your thoughts on '${discourse.title || 'this topic'}'.`;
            if (bodyEl) bodyEl.innerHTML = discourse.body || '<p>Content not available.</p>';

            if (categoryContainer) {
                // Clear it first
                categoryContainer.innerHTML = ''; 

                if (discourse.category_name && discourse.subcategory_name) {
                    const newCategorySpan = document.createElement('span');
                    newCategorySpan.className = 'discourse-category';
                    newCategorySpan.id = 'discourse-category-display'; // Re-assign ID
                    newCategorySpan.textContent = `${discourse.category_name} > ${discourse.subcategory_name}`;
                    categoryContainer.appendChild(newCategorySpan);
                }
            }
            
            if (imageContainer) {
                imageContainer.innerHTML = '';
                if (discourse.featured_image_url) {
                    const img = document.createElement('img');
                    img.src = discourse.featured_image_url;
                    img.alt = discourse.title;
                    img.className = 'featured-image';
                    imageContainer.appendChild(img);
                }
            }
            if (resourceList) {
                resourceList.innerHTML = '';
                if (discourse.resources && discourse.resources.length > 0) {
                    discourse.resources.forEach(resource => {
                        const li = document.createElement('li');

                        // 1. Get the values from the updated API response
                        const typeValue = resource.type_value || 'Unknown'; // e.g., 'Academic Paper'
                        const typeName = resource.type_name || 'OTHER';     // e.g., 'ACADEMIC_PAPER'

                        // 2. Recreate the slug logic from the Jinja template
                        const resourceSlug = typeName.toLowerCase().replace(/_/g, '-');

                        // 3. Recreate the icon logic
                        const iconClass = (typeName === 'SCRIPTURE') ? 'fa-book-bible' : 'fa-link';
                        
                        // 4. Build the correct innerHTML with the inline style
                        li.innerHTML = `
                            <span class="resource-type" style="--resource-bg-color: var(--color-resource-${resourceSlug});">
                                ${typeValue[0]}
                            </span>
                            <strong>${resource.name}:</strong> 
                            <a href="${resource.link}" target="_blank" rel="noopener noreferrer">
                                <i class="fas ${iconClass}" aria-hidden="true"></i>
                            </a>`;

                        resourceList.appendChild(li);
                    });
                } else {
                    resourceList.innerHTML = '<li>No resources are listed for this discourse.</li>';
                }
            }
            
            // NEW: Update the comments section based on API data
            if (viewCommentsBtn && commentListContainer) {
                const commentCount = discourse.comments ? discourse.comments.length : 0;
                viewCommentsBtn.textContent = `View Contributions (${commentCount})`;

                commentListContainer.innerHTML = ''; // Clear previous comments

                if (commentCount > 0) {
                    discourse.comments.forEach(comment => {
                        const commentDiv = document.createElement('div');
                        commentDiv.className = 'comment-item';
                        commentDiv.innerHTML = `
                            <p class="comment-body mb-1">${comment.body}</p>
                            <small class="comment-meta text-muted">
                                &mdash; ${comment.author_name} on ${comment.date_commented}
                            </small>
                        `;
                        commentListContainer.appendChild(commentDiv);
                    });
                } else {
                    commentListContainer.innerHTML = '<p class="text-center text-muted m-2">Be the first to contribute!</p>';
                }
            }
                        // NEW: Update the author name in the footer
            const authorNameEl = document.getElementById('discourse-author-name');
            if (authorNameEl && discourse.author) {
                authorNameEl.innerHTML = `<strong>Author: </strong> ${discourse.author.name} ${discourse.author.other_names}`;
            }

            // NEW: Update the content of the author modal
            if (discourse.author) {
                document.getElementById('modal-author-name').textContent = `${discourse.author.name} ${discourse.author.other_names}`;
                document.getElementById('modal-author-org').textContent = discourse.author.organization_name || 'Not Provided';
                document.getElementById('modal-author-email').textContent = discourse.author.email || 'Not Provided';
                document.getElementById('modal-author-contact').textContent = discourse.author.contact || 'Not Provided';
                document.getElementById('modal-author-education').textContent = discourse.author.education || 'Information not available.';
                document.getElementById('modal-author-career').textContent = discourse.author.career || 'Information not available.';
                document.getElementById('modal-author-website').textContent = discourse.author.website || 'Information not available.';
            }
        }

        async function loadDiscourse(discourseId) {
            if (!discourseId) return;
            // (Concise Old Content: This part handled opacity and nav button state.)
            container.style.opacity = '0.5';
            prevBtn.disabled = true;
            nextBtn.disabled = true;
            // MODIFIED: Disable comment form during loading
            if (commentTextarea) commentTextarea.disabled = true;
            if (submitCommentBtn) submitCommentBtn.disabled = true;

            try {
                const response = await fetch(`/discourse/api/get/${discourseId}`);
                if (!response.ok) throw new Error('Failed to fetch discourse content.');
                const result = await response.json();
                if (result.status === 'success') {
                    // (Concise Old Content: This called updateDiscourseContent and fetchAndUpdateNavigation.)
                    updateDiscourseContent(result.discourse); // Now updates comments too
                    navigationState.currentId = discourseId;
                    await fetchAndUpdateNavigation(discourseId);
                    
                    // MODIFIED: Re-enable comment form for logged-in users after loading
                    {% if current_user.is_authenticated %}
                        if (commentTextarea) commentTextarea.disabled = false;
                        if (submitCommentBtn) submitCommentBtn.disabled = false;
                    {% endif %}
                }
            } catch (error) {
                console.error('Error loading discourse:', error);
            } finally {
                container.style.opacity = '1';
            }
        }

        async function fetchAndUpdateNavigation(discourseId) {
            // (Concise Old Content: This function remains unchanged.)
            if (!discourseId) {
                updateNavButtonState();
                return;
            }
            try {
                const response = await fetch(`/discourse/api/navigation/${discourseId}`);
                if (!response.ok) throw new Error('Failed to fetch navigation links.');
                const navData = await response.json();
                if (navData.status === 'success') {
                    navigationState.prevId = navData.previous_id;
                    navigationState.nextId = navData.next_id;
                    updateNavButtonState();
                }
            } catch (error) { console.error('Error fetching navigation:', error); }
        }

        function updateNavButtonState() {
            // (Concise Old Content: This function remains unchanged.)
            prevBtn.disabled = !navigationState.prevId;
            nextBtn.disabled = !navigationState.nextId;
        }

        // NEW: Function to handle submitting the contribution form
        async function handleSubmitComment() {
            const commentBody = commentTextarea.value.trim();
            const discourseId = navigationState.currentId;

            if (!discourseId) {
                commentStatusMsg.textContent = 'No discourse loaded.';
                commentStatusMsg.className = 'text-danger';
                return;
            }
            if (!commentBody) {
                commentStatusMsg.textContent = 'Please enter your contribution.';
                commentStatusMsg.className = 'text-danger';
                return;
            }

            submitCommentBtn.disabled = true;
            commentStatusMsg.textContent = 'Submitting...';
            commentStatusMsg.className = 'text-muted';

            try {
                const response = await fetch('/discourse/api/add-comment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        discourse_id: discourseId,
                        comment_body: commentBody
                    })
                });

                const result = await response.json();
                if (response.ok) {
                    commentStatusMsg.textContent = result.message || 'Success!';
                    commentStatusMsg.className = 'text-success';
                    commentTextarea.value = '';
                    // NEW: Reload the discourse to show the new comment immediately
                    loadDiscourse(discourseId); 
                } else {
                    commentStatusMsg.textContent = result.message || 'An error occurred.';
                    commentStatusMsg.className = 'text-danger';
                }

            } catch (error) {
                console.error('Error submitting comment:', error);
                commentStatusMsg.textContent = 'A network error occurred.';
                commentStatusMsg.className = 'text-danger';
            } finally {
                submitCommentBtn.disabled = false;
                setTimeout(() => { commentStatusMsg.textContent = ''; }, 5000);
            }
        }

        // --- 3. EVENT LISTENERS & INITIALIZATION ---
        // (Concise Old Content: Event listeners for nav buttons existed here.)
        prevBtn.addEventListener('click', () => {
            if (navigationState.prevId) loadDiscourse(navigationState.prevId);
        });
        nextBtn.addEventListener('click', () => {
            if (navigationState.nextId) loadDiscourse(navigationState.nextId);
        });

        // NEW: Add event listener for the comment submission button
        if (submitCommentBtn) {
            submitCommentBtn.addEventListener('click', handleSubmitComment);
        }

        const initialId = container.dataset.initialDiscourseId;
        if (initialId) {
            navigationState.currentId = parseInt(initialId, 10);
            fetchAndUpdateNavigation(navigationState.currentId);
        }
        
        // NEW: Logic to disable comment section if user is not logged in or no content is shown
        {% if not current_user.is_authenticated %}
            if (commentTextarea) {
                commentTextarea.placeholder = 'Please log in to contribute.';
                commentTextarea.disabled = true;
            }
            if (submitCommentBtn) submitCommentBtn.disabled = true;
        {% elif not initial_content %}
             if (commentTextarea) commentTextarea.disabled = true;
             if (submitCommentBtn) submitCommentBtn.disabled = true;
        {% endif %}
    });
    </script>
{% endblock %}