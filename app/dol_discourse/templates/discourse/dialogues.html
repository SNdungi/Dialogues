{% extends "layout.html" %}

{% block content %}
    <!-- Sticky Header within Main Content -->
    <div class="sticky-main-header d-flex justify-content-between align-items-center g-5">
        <h3 class="me-5 mb-0">Daily Discourse</h3>

        <!-- ================================================================ -->
        <!-- FIX 1: Buttons moved to the header for better usability.         -->
        <!-- They are disabled via Jinja if there's no initial content.     -->
        <!-- ================================================================ -->
        <div class="discourse-navigation-controls">
            <button id="prev-discourse-btn" class="btn btn-outline-secondary btn-sm" title="Previous Discourse" {% if not initial_content %}disabled{% endif %}>
                <i class="fa fa-chevron-left"></i>
            </button>
            <button id="next-discourse-btn" class="btn btn-outline-secondary btn-sm" title="Next Discourse" {% if not initial_content %}disabled{% endif %}>
                <i class="fa fa-chevron-right"></i>
            </button>
        </div>
        
        <!-- Search Bar -->
        <div>
            <input type="text" class="search-input" placeholder="Search Topics, Titles..." id="searchInput">
            <button class="search-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-search" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001q.044.06.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1 1 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0"/></svg>
            </button>
        </div>
        
        <!-- Action Buttons -->
        <div class="d-flex align-items-center ms-3">
            {% if initial_content and current_user.is_authenticated and (current_user.id == initial_content.author.id or current_user.has_role('Admin') or current_user.has_role('Editor')) %}
                <a href="{{ url_for('discourse.edit_discourse', discourse_id=initial_content.id) }}" class="btn btn-secondary btn-sm me-2">
                    <i class="fa fa-pencil-alt"></i>
                </a>
            {% endif %}
            <a href="{{ url_for('discourse.new_discourse_editor') }}" class="btn btn-warning btn-sm">
                <i class="fa fa-plus"></i>
            </a>
        </div>
    </div>

    <!-- Main content container -->
    <div class="discourse-container" id="discourse-content-wrapper" data-initial-discourse-id="{{ initial_content.id if initial_content else '' }}">
        
        {% if initial_content %}
            <section id="discourse-section">
                <div class="discourse-meta">
                    <span id="discourse-date">{{ initial_content.date_posted.strftime('%B %d, %Y') }}</span>
                    {% if initial_content.subcategory and initial_content.subcategory.category %}
                        <span class="discourse-category">
                            {{ initial_content.subcategory.category.name }} > {{ initial_content.subcategory.name }}
                        </span>
                    {% endif %}
                    <span id="discourse-ref">Reference: {{ initial_content.reference }}</span>
                </div>
                
                <h4 id="discourse-title">{{ initial_content.title }}</h4>
                
                <div id="featured-image-container">
                    {% if initial_content.featured_image %}
                    <img src="{{ url_for('static', filename='uploads/discourse_images/' + initial_content.featured_image) }}" alt="{{ initial_content.title }}" class="featured-image">
                    {% endif %}
                </div>
                
                <div id="discourse-body">
                    {{ initial_content.body | safe }}
                </div>
            </section>

            <section id="resources-section">
                <h4>Resources & References</h4>
                <ul id="resource-list">
                    {% for resource in initial_content.resources %}
                    <li>
                        <span class="resource-type {{ resource.type.value | lower | replace(' ', '-') }}">{{ resource.type.value[0] }}</span>
                        <strong>{{ resource.name }}:</strong> 
                        {% if resource.link %}
                            <a href="{{ resource.link }}" target="_blank" rel="noopener noreferrer">                                
                                {% if resource.type.name == 'SCRIPTURE' %}
                                    <i class="fas fa-book-bible" aria-hidden="true" title="Read Scripture"></i>
                                {% else %}
                                    <i class="fas fa-link" aria-hidden="true" title="External Link"></i>
                                {% endif %}
                            </a>
                        {% endif %}
                    </li>
                    {% else %}
                    <li>No resources are listed for this discourse.</li>
                    {% endfor %}
                </ul>
            </section>

            <section id="contribute-section">
                <h4>Join this Discourse</h4>
                <p id="contribute-prompt">Share your thoughts on '{{ initial_content.title }}'.</p>
                <textarea placeholder="Contribute your perspective..."></textarea>
                <div class="d-flex justify-content-between">
                    <button class="btn btn-sm btn-primary">Submit Contribution</button>
                    <!-- FIX 2: Removed the duplicate navigation buttons from here -->
                </div>
            </section>

        {% else %}

            <!-- B. Display a welcoming "empty state" -->
            <section id="discourse-section" class="empty-state">
                <div class="discourse-meta">
                    <span id="discourse-date">Today</span>
                    <span id="discourse-ref">Reference: N/A</span>
                </div>
                <h4 id="discourse-title">Welcome to the Dialogues</h4>
                <div id="discourse-body">
                    <p>There are no approved articles to display at the moment.</p>
                </div>
            </section>

            <section id="resources-section" class="empty-state">
                <h4>Resources & References</h4>
                <ul id="resource-list"><li>No resources to display.</li></ul>
            </section>

            <section id="contribute-section" class="empty-state">
                <h4>Join this Discourse</h4>
                <p id="contribute-prompt">Share your thoughts once a topic is available.</p>
                <textarea placeholder="Contribute your perspective..." disabled></textarea>
                 <div class="d-flex justify-content-between">
                    <button class="btn btn-sm btn-primary" disabled>Submit Contribution</button>
                    <!-- FIX 2: Removed the duplicate navigation buttons from here -->
                </div>
            </section>

        {% endif %}
    </div>

    <!-- ================================================================ -->
    <!-- FIX 3: THE SCRIPT IS NOW SELF-CONTAINED AND COMPLETE           -->
    <!-- ================================================================ -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const container = document.getElementById('discourse-content-wrapper');
        if (!container) return;

        // --- 1. ELEMENT CACHING & STATE ---
        const prevBtn = document.getElementById('prev-discourse-btn');
        const nextBtn = document.getElementById('next-discourse-btn');
        const navigationState = { currentId: null, prevId: null, nextId: null };

        // --- 2. CORE FUNCTIONS ---

        /**
         * The helper function to update the DOM is now HERE, inside this script.
         * This makes the script self-contained and resolves the error.
         */
        function updateDiscourseContent(discourse) {
            const titleEl = document.getElementById('discourse-title');
            const bodyEl = document.getElementById('discourse-body');
            const dateEl = document.getElementById('discourse-date');
            const refEl = document.getElementById('discourse-ref');
            const promptEl = document.getElementById('contribute-prompt');
            const imageContainer = document.getElementById('featured-image-container');
            const resourceList = document.getElementById('resource-list');

            if (titleEl) titleEl.textContent = discourse.title || 'N/A';
            if (dateEl) dateEl.textContent = discourse.date_posted || '';
            if (refEl) refEl.textContent = discourse.reference ? `Reference: ${discourse.reference}` : '';
            if (promptEl) promptEl.textContent = `Share your thoughts on '${discourse.title || 'this topic'}'.`;
            if (bodyEl) bodyEl.innerHTML = discourse.body || '<p>Content not available.</p>';
            
            if (imageContainer) {
                imageContainer.innerHTML = '';
                if (discourse.featured_image_url) {
                    const img = document.createElement('img');
                    img.src = discourse.featured_image_url;
                    img.alt = discourse.title;
                    img.className = 'featured-image';
                    imageContainer.appendChild(img);
                }
            }
            if (resourceList) {
                resourceList.innerHTML = '';
                if (discourse.resources && discourse.resources.length > 0) {
                    discourse.resources.forEach(resource => {
                        const li = document.createElement('li');
                        const typeInitial = resource.type ? resource.type[0] : '?';
                        const typeClass = resource.type ? resource.type.toLowerCase().replace(/\s+/g, '-') : 'unknown';
                        const iconClass = (resource.type === 'Scripture') ? 'fa-book-bible' : 'fa-link';
                        li.innerHTML = `
                            <span class="resource-type ${typeClass}">${typeInitial}</span>
                            <strong>${resource.name}:</strong> 
                            <a href="${resource.link}" target="_blank" rel="noopener noreferrer">
                                <i class="fas ${iconClass}" aria-hidden="true"></i>
                            </a>`;
                        resourceList.appendChild(li);
                    });
                } else {
                    resourceList.innerHTML = '<li>No resources are listed for this discourse.</li>';
                }
            }
        }

        async function loadDiscourse(discourseId) {
            if (!discourseId) return;
            container.style.opacity = '0.5';
            prevBtn.disabled = true;
            nextBtn.disabled = true;

            try {
                const response = await fetch(`/discourse/api/get/${discourseId}`);
                if (!response.ok) throw new Error('Failed to fetch discourse content.');
                const result = await response.json();
                if (result.status === 'success') {
                    updateDiscourseContent(result.discourse);
                    navigationState.currentId = discourseId;
                    await fetchAndUpdateNavigation(discourseId);
                }
            } catch (error) {
                console.error('Error loading discourse:', error);
            } finally {
                container.style.opacity = '1';
            }
        }

        async function fetchAndUpdateNavigation(discourseId) {
            if (!discourseId) {
                updateNavButtonState();
                return;
            }
            try {
                const response = await fetch(`/discourse/api/navigation/${discourseId}`);
                if (!response.ok) throw new Error('Failed to fetch navigation links.');
                const navData = await response.json();
                if (navData.status === 'success') {
                    navigationState.prevId = navData.previous_id;
                    navigationState.nextId = navData.next_id;
                    updateNavButtonState();
                }
            } catch (error) {
                console.error('Error fetching navigation:', error);
            }
        }

        function updateNavButtonState() {
            prevBtn.disabled = !navigationState.prevId;
            nextBtn.disabled = !navigationState.nextId;
        }

        // --- 3. EVENT LISTENERS & INITIALIZATION ---
        prevBtn.addEventListener('click', () => {
            if (navigationState.prevId) loadDiscourse(navigationState.prevId);
        });
        nextBtn.addEventListener('click', () => {
            if (navigationState.nextId) loadDiscourse(navigationState.nextId);
        });

        const initialId = container.dataset.initialDiscourseId;
        if (initialId) {
            navigationState.currentId = parseInt(initialId, 10);
            fetchAndUpdateNavigation(navigationState.currentId);
        }
    });
    </script>
{% endblock %}